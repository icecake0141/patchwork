# Copyright 2026 Patchwork Authors
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# This file was created or modified with the assistance of an AI (Large Language Model).
# Review required for correctness, security, and licensing.

name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - main

# Cancel in-progress runs for the same workflow + PR/branch to avoid wasting runner minutes.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Minimal permissions â€” jobs only need to read repository contents.
permissions:
  contents: read

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      runtime: ${{ steps.filter.outputs.runtime }}
      compat: ${{ steps.filter.outputs.compat }}
      depfiles: ${{ steps.filter.outputs.depfiles }}
      docs_only: ${{ steps.classify.outputs.docs_only }}
      docker: ${{ steps.filter.outputs.docker }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect changed file groups
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            runtime:
              - '**/*.py'
              - 'templates/**'
              - 'requirements.txt'
              - 'pyproject.toml'
            compat:
              - 'services/**'
              - 'models.py'
              - 'db.py'
              - 'requirements.txt'
              - 'pyproject.toml'
            depfiles:
              - 'requirements.txt'
              - 'pyproject.toml'
            docker:
              - 'Dockerfile'
              - '.dockerignore'
              - 'docker-compose.yml'
              - 'docker/**'
              - 'tests/test_docker_compose.py'
              - '.github/workflows/ci.yml'

      - name: Classify docs-only change
        id: classify
        run: |
          if [[ "${{ steps.filter.outputs.runtime }}" == "false" && "${{ steps.filter.outputs.docker }}" == "false" ]]; then
            echo "docs_only=true" >> "$GITHUB_OUTPUT"
          else
            echo "docs_only=false" >> "$GITHUB_OUTPUT"
          fi

  docs-fastpath:
    name: Docs Fast Path
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.docs_only == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Docs-only summary
        run: echo "Docs-only change detected; expensive runtime jobs are skipped by design."

  dependabot-fastpath:
    name: Dependabot Fast Path
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'pull_request' && github.actor == 'dependabot[bot]' && needs.changes.outputs.depfiles == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Fast lint/static gate
        run: |
          ruff check .
          mypy .

      - name: Fast regression test gate
        run: pytest -q tests/test_models_validation.py tests/test_allocator_acceptance.py tests/test_export.py

  lint-and-typecheck:
    # Lint, format, and type-check run on a single Python version.
    # mypy is configured for python_version = "3.10"; no benefit from repeating on 3.11/3.12.
    name: Lint / Format / Type Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.runtime == 'true' && !(github.event_name == 'pull_request' && github.actor == 'dependabot[bot]' && needs.changes.outputs.depfiles == 'true')

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Run ruff
        run: ruff check .

      - name: Run black (check mode)
        run: black --check .

      - name: Run mypy
        run: mypy .

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.runtime == 'true' && !(github.event_name == 'pull_request' && github.actor == 'dependabot[bot]' && needs.changes.outputs.depfiles == 'true')
    strategy:
      fail-fast: false
      matrix:
        # PRs stay single-version; push to main expands only when compatibility-sensitive files changed.
        python-version: ${{ fromJSON(github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.changes.outputs.compat == 'true' && '["3.10","3.12"]' || '["3.10"]') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Run pytest
        run: pytest -q

  docker-integration:
    name: Docker Integration
    runs-on: ubuntu-latest
    needs: changes
    # Expensive integration is restricted to default-branch pushes touching Docker-related files.
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.changes.outputs.docker == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Run Docker integration tests
        env:
          RUN_DOCKER_TESTS: "1"
        run: pytest -q tests/test_docker_compose.py
